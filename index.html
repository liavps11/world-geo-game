<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Geography Quiz - Fixed</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; overflow: hidden; background-color: #87CEEB; }
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #87CEEB; }
        #ui-container {
            position: absolute; top: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(44, 62, 80, 0.95); padding: 8px 20px;
            display: flex; align-items: center; justify-content: center; height: 70px;
            color: white; border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        #score-corner { position: absolute; left: 15px; background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 20px; font-weight: bold; }
        #country-name { font-size: 24px; font-weight: bold; margin-left: 10px; background: #2ecc71; padding: 4px 12px; border-radius: 5px; }
        #on-screen-feedback {
            position: absolute; z-index: 1500; font-weight: bold; color: white;
            background: rgba(0, 0, 0, 0.8); padding: 5px 10px; border-radius: 4px;
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        #on-screen-feedback.show { opacity: 1; }
        .region-path { cursor: pointer; transition: all 0.2s; }
        /* FLASH & PULSE */
        @keyframes pulse-red { 50% { fill: #e74c3c !important; fill-opacity: 0.7; } }
        .pulse-red { animation: pulse-red 1s infinite; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="ui-container">
    <div id="score-corner">Score: <span id="score-value">0</span></div>
    <div>Find: <span id="country-name">CLICK TO START</span></div>
</div>
<div id="on-screen-feedback"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const somaliaPatch = [[[41.5, -1.6], [41.0, 2.8], [42.8, 4.3], [45.0, 5.0], [49.0, 9.5], [43.3, 11.5], [48.9, 11.9], [51.2, 11.9], [51.1, 9.5], [49.2, 6.5], [45.3, 2.0], [41.5, -1.6]]];
    
    // Manual dots for small islands you mentioned
    const extraIslands = [
        { name: "Mauritius", lat: -20.348, lng: 57.552 },
        { name: "Seychelles", lat: -4.679, lng: 55.492 },
        { name: "Comoros", lat: -11.645, lng: 43.333 }
    ];

    let map, gameState = { started: false, current: null, score: 0, remaining: [] };
    let layers = {};

    function init() {
        map = L.map('map', { center: [10, 20], zoom: 3, minZoom: 2, attributionControl: false });
        loadMap();
    }

    async function loadMap() {
        const res = await fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json');
        const data = await res.json();

        data.features.forEach(f => {
            let name = f.properties.name;
            // FIX 1: Rename Swaziland to Eswatini
            if (name === "Swaziland") name = "Eswatini";
            if (name === "Somaliland") return; 

            const geoLayer = L.geoJSON(f, {
                style: { fillColor: '#27ae60', fillOpacity: 0.9, color: 'white', weight: 1 },
                onEachFeature: (feature, layer) => {
                    if (name === "Somalia") layer.setLatLngs(somaliaPatch);
                    
                    // FIX 3: Re-add Hover Highlight
                    layer.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 0.5, weight: 3 });
                    });
                    layer.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.9, weight: 1 });
                    });

                    layer.on('click', (e) => handleResult(name, e));
                }
            }).addTo(map);
            
            layers[name] = geoLayer;
            gameState.remaining.push(name);
        });

        // FIX 2: Add Islands as dots
        extraIslands.forEach(isl => {
            const dot = L.circleMarker([isl.lat, isl.lng], {
                radius: 6, fillColor: "#27ae60", color: "white", weight: 2, fillOpacity: 1
            }).addTo(map);
            dot.on('click', (e) => handleResult(isl.name, e));
            layers[isl.name] = dot;
            gameState.remaining.push(isl.name);
        });
    }

    function handleResult(name, e) {
        if (!gameState.started) {
            gameState.started = true;
            return next();
        }

        if (name === gameState.current) {
            gameState.score++;
            document.getElementById('score-value').textContent = gameState.score;
            next();
        } else {
            const pt = map.mouseEventToContainerPoint(e.originalEvent);
            const fb = document.getElementById('on-screen-feedback');
            fb.textContent = "That is " + name;
            fb.style.left = pt.x + "px"; fb.style.top = pt.y + "px";
            fb.classList.add('show');
            setTimeout(() => fb.classList.remove('show'), 1200);
        }
    }

    function next() {
        if (gameState.remaining.length === 0) {
            document.getElementById('country-name').textContent = "DONE!";
            return;
        }
        const idx = Math.floor(Math.random() * gameState.remaining.length);
        gameState.current = gameState.remaining.splice(idx, 1)[0];
        document.getElementById('country-name').textContent = gameState.current;
    }

    window.onload = init;
</script>
</body>
</html>
