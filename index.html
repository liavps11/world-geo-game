<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Seterra-style World + US States Game</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body { height: 100%; margin: 0; padding: 0; }
body { font-family: Arial; text-align: center; background: #f4f4f4; }
#question { font-size: 24px; padding: 10px; }
#map { width: 100%; height: 90vh; }
.leaflet-interactive { fill: #4CAF50; stroke: white; stroke-width: 1; cursor: pointer; transition: fill 0.3s; }
</style>
</head>
<body>

<div id="question">Loading...</div>
<div id="map"></div>

<script>
let map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20,0], 2);
let score = 0;
let current = null;
let allLocations = [];
let attempts = {};
let layersMap = {};

// Fit map to all features once loaded
let bounds = L.latLngBounds([]);

function nextQuestion() {
    current = allLocations[Math.floor(Math.random() * allLocations.length)];
    attempts[current] = 0;
    document.getElementById("question").innerText = "Click: " + current + " | Score: " + score;
}

// Handle click coloring and feedback
function handleClick(name, layer) {
    attempts[name]++;
    if(name === current){
        if(attempts[name] === 1){
            layer.setStyle({fillColor: "white"});
        } else if(attempts[name] === 2){
            layer.setStyle({fillColor: "#FFFF00"}); // yellow
        } else if(attempts[name] === 3){
            layer.setStyle({fillColor: "#FFA500"}); // orange
        } else {
            layer.setStyle({fillColor: "#FF0000"}); // red
        }
        score++;
        setTimeout(()=> {
            layer.setStyle({fillColor: "#4CAF50"});
            nextQuestion();
        }, 500);
    } else {
        // Wrong click
        layer.setStyle({fillColor: "#FF0000"});
        document.getElementById("question").innerText = "Error! Click: " + current + " | Score: " + score;
        setTimeout(()=> layer.setStyle({fillColor: "#4CAF50"}), 400);

        // Flash correct country after 3 attempts
        if(attempts[current] >=3){
            let correctLayer = layersMap[current];
            if(correctLayer){
                correctLayer.setStyle({fillColor: "#FFFF00"});
                setTimeout(()=> correctLayer.setStyle({fillColor: "#4CAF50"}), 1000);
            }
        }
    }
}

// Setup feature interaction
function onEachFeature(feature, layer){
    let name = feature.properties.ADMIN || feature.properties.name;
    allLocations.push(name);
    layersMap[name] = layer;
    bounds.extend(layer.getBounds ? layer.getBounds() : layer.getLatLng ? layer.getLatLng() : [layer.getBounds ? layer.getBounds() : [0,0]]);
    layer.on("click", () => handleClick(name, layer));
}

// Load world countries
fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")
.then(res => res.json())
.then(data => {
    L.geoJSON(data, {onEachFeature:onEachFeature}).addTo(map);
    map.fitBounds(bounds);
    nextQuestion();
});

// Load US states
fetch("https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json")
.then(res => res.json())
.then(data => {
    L.geoJSON(data, {onEachFeature:onEachFeature}).addTo(map);
    map.fitBounds(bounds);
});

</script>

</body>
</html>
